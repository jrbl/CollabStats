#!/usr/bin/env python
# -*- coding: utf-8 -*-
#########+#########+#########+#########+#########+#########+#########+#########+#########+#########+#########+#########+
#Copyright (C) 2009  Joe Blaylock <jrbl@jrbl.org>
#
#This program is free software: you can redistribute it and/or modify it under 
#the terms of the GNU General Public License as published by the Free Software 
#Foundation, either version 3 of the License, or (at your option) any later 
#version.
#
#This program is distributed in the hope that it will be useful, but WITHOUT 
#ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or 
#FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more 
#details.
#
#You should have received a copy of the GNU General Public License along with 
#this program.  If not, see <http://www.gnu.org/licenses/>.
#########+#########+#########+#########+#########+#########+#########+#########+#########+#########+#########+#########+
"""ircstats - a little script to parse XML IRC logs and gather stats from them

Cf. http://forge.blueoxen.net/wiki/IRC_Analytics
Cf. RFC 2812
Cf. http://colloquy.info/project/wiki/Development/Styles/LogFileFormat
"""

import xml.dom.minidom as md
from datetime import datetime

import UserTable
from ircColloquy import *


#########+#########+#########+#########+#########+#########+#########+#########+#########+#########+#########+#########+
DEBUG     = False
VERSION   = "0.2"


#########+#########+#########+#########+#########+#########+#########+#########+#########+#########+#########+#########+

def usersByID(userTable):
    for name in sorted(userTable.keys()):
        yield userTable[name]

def count_messages(user, day = None):
    if day:
        return len( [t for t in user.messages.keys() if t.date() == day] )
    return len(user.messages.keys())

def count_actions(user,day = None):
    if day:
        return len( [t for t in user.actions.keys() if t.date() == day] )
    return len(user.actions.keys())
        
def statsForUser(user, msgcount = None, actcount = None):
    """Returns (nick, message_count, act_count, message_ratio, act_ratio)
       
    msgcount is the total count of messages seen since the dawn of time
    actcount is the same, for actions

    message_ratio is the ratio of messages this user produced, to all messages
    act_ratio is the ratio of actions this user emitted, to all actions
    """

    nick = user.nick
    msgs = count_messages(user)
    acts = count_actions(user)
    msgrat = 0
    actrat = 0
    if msgcount != None:
        msgrat = float(msgs)/msgcount
    if actcount != None:
        actrat = float(acts)/actcount

    return (nick, msgs, acts, msgrat, actrat)

def count_everything(userTable, day = None):
    """Make a complete pass through the user database, gathering the total count of messages and acts.

    FIXME: this is an unbearably slow and stupid algorithm.  We should be computing and caching this data.
    """
    msgcount = 0
    actcount = 0
    for id in userTable.keys():
        msgcount += count_messages(userTable[id], day)
        actcount += count_actions(userTable[id], day)
    return (msgcount, actcount)

def getDayList(userTable):
    """Make a complete pass through the user database, gathering information about what days had activity.
       
    FIXME: this is an unbearably slow and stupid algorithm.  We should be computing and caching this data.
    """
    daylist = []
    for id in userTable.keys():
        for d in [t.date() for t in userTable[id].messages.keys()]:
            if d not in daylist:
                daylist.append(d)
        for d in [t.date() for t in userTable[id].actions.keys()]:
            if d not in daylist:
                daylist.append(d)
    return daylist

def setup_optparse():
    import optparse
    usage = "usage: %prog [options] file1.xml [file2.xml] [...]"
    parser = optparse.OptionParser(usage=usage, version=VERSION)
    parser.add_option('-c', "--csv",      dest="csv",      action="store_true", default=False, 
                      help="Write a CSV-formatted file of all statistics to stdout")
    parser.add_option('-t', "--totals",   dest="totals",   action="store_true", default=False, 
                      help="Output summary totals of messages and actions")
    parser.add_option('-m', "--messages", dest="messages", action="store_true", default=False, 
                      help="Output message counts per username")
    parser.add_option('-a', "--actions",  dest="actions",  action="store_true", default=False, 
                      help="Output action counts per username")
    parser.add_option('-l', "--lurkers",  dest="lurkers",  action="store_true", default=False, 
                      help="Output list of lurkers - users who don't say anything")
    parser.add_option('-d', "--debug",    dest="debug",    action="store_true", default=False, 
                      help="Enable debug mode.  Really, it's not that great.")
    options, args = parser.parse_args()
    return parser

def getReportHeader(typeword, daylist):
    header = typeword + " by user:\n"
    header += "\t%4s  %4s  %20s " % ("All", "All", " ")
    for day in daylist:
        sd = str(day)
        header += "  %10s %10s" % (sd, sd)
    header += '\n'
    header += '\t%4s  %4s  %15s      ' % ("Msgs", "%Tot", "IRC Nick")
    for day in daylist:
        header += "  %10s %10s" % ("Msgs", "%Tot")
    return header

def getReportLineByFunc(func, total, table, eco, daylist):
    for id in table:
        res = func( table[id] )
        if res > 0:
            line = '\t %3d  %.2f  %20s ' % ( res, float(res)/total, table.idToName(id) )
            for day in daylist:
                m, a = eco[ day ]
                line += "  %10d %10.2f" % ( res, float(res)/m )
            yield line

#########+#########+#########+#########+#########+#########+#########+#########+#########+#########+#########+#########+
if __name__ == "__main__":

    option_parser = setup_optparse()
    options, args = option_parser.parse_args()

    if options.debug: DEBUG = True

    # Read in on-disk data stores; set up mapping dictionaries
    userTable = UserTable.UserTable(mapping_yaml = 'usernames.yaml', user_objects_db = 'irc_users.pickle')
    
    # Read in and process user log file
    for filename in args:
        dom = md.parse(filename)                           # should be in ircColloquy.py?
        assert dom.documentElement.tagName == u"log"
        handleLogDOM(dom.documentElement, userTable)
        dom.unlink()

    msgcount, actcount = count_everything(userTable)
    daylist = getDayList(userTable)

    everything_counted_once = {}
    for day in daylist:
        everything_counted_once[day] = count_everything(userTable, day)

    if options.totals:
        print "Total messages:", msgcount + actcount
        print "Messages:", msgcount
        print "Actions:", actcount
        print "%10s %10s %10s" % ("Date", "Messages", "Actions")
        for day in daylist:
            m, a = everything_counted_once[day]
            print "%10s %10s %10s" % (str(day), str(m), str(a) )

    if options.messages:
        print getReportHeader("Messages", daylist)
        for line in getReportLineByFunc(count_messages, msgcount, userTable, everything_counted_once, daylist):
            print line

    if options.actions:
        print getReportHeader("Actions", daylist)
        for line in getReportLineByFunc(count_actions, actcount, userTable, everything_counted_once, daylist):
            print line

    if options.lurkers: # FIXME
        lurkers = []
        semilurk = []
        header = "Lurkers and Action-only Users:\n"
        header += "%20s  " % "Name"
        for day in daylist:
            header += "%10s  " % str(day)
        print header

        for id in userTable:
            user = userTable[id]
            stats = statsForUser(user, msgcount, actcount)
            if stats[1] == 0 and stats[2] == 0:
                lurkers.append(userTable.idToName(user.id))
            elif stats[2] == 0:
                semilurk.append(userTable.idToName(user.id))
        for name in lurkers: 
            print '%20s' % name
        if len(semilurk) == 0:
            print "No action-only users"
        else:
            print "Action-only users:"
            for name in semilurk:
                print '\t %s' % name

    if options.csv: # FIXME
        import csv, sys
        csv.register_dialect("ooffice_like", delimiter=',', skipinitialspace=True, 
                                                            lineterminator="\n", quoting=csv.QUOTE_NONNUMERIC)
        def statsTuples():
            yield ("IRC Nick", "Message Count", "Action Count", "Messages/Total Messages", "Actions/Total Actions")
            for user in usersByID(userTable):
                yield statsForUser(user, msgcount, actcount)
        csv.writer(sys.stdout, dialect="ooffice_like").writerows(statsTuples())

    userTable.close()
